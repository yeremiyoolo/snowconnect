// 1. Generador del Cliente
generator client {
  provider = "prisma-client-js"
}

// 2. Configuración de la Base de Datos
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// CONFIGURACIÓN GLOBAL
// ==========================================
model StoreSettings {
  id            String   @id @default(cuid())
  updatedAt     DateTime @updatedAt
  storeName     String   @default("SnowConnect")
  description   String?  @db.Text
  supportEmail  String?
  supportPhone  String?
  whatsapp      String?  
  address       String?
  logoUrl       String?  
}

// ==========================================
// USUARIO & AUTENTICACIÓN
// ==========================================
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          String    @default("USER")
  
  telefono      String?   @unique 
  bio           String?
  ubicacion     String?
  
  snowCashBalance Float   @default(0.00)
  currency      String    @default("DOP")
  language      String    @default("es")
  theme         String    @default("system")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  identity      IdentityVerification? 
  addresses     Address[]
  bankAccounts  BankAccount[]         
  notifications NotificationSettings?
  walletTransactions WalletTransaction[]   
  orders        Order[]           
  repairs       RepairTicket[]    
  quotes        QuoteRequest[]    
  
  // Relaciones con Sistema
  productos     Producto[] 
  ventas        Venta[]    
  logs          AuditLog[]
  wishlist      Wishlist[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  @@unique([identifier, token])
}

// ==========================================
// MÓDULOS SNOWCONNECT ID
// ==========================================
model WalletTransaction {
  id          String          @id @default(cuid())
  amount      Float
  type        TransactionType 
  description String
  referenceId String?         
  createdAt   DateTime        @default(now())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum TransactionType {
  CREDIT
  DEBIT
}

model IdentityVerification {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentType   String   
  documentNumber String
  frontImage     String   
  backImage      String?  
  status         String   @default("PENDING") 
  rejectionReason String?
  verifiedAt     DateTime?
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String   
  recipient   String
  phone       String
  street      String
  city        String
  province    String
  details     String?  
  coordinates String?  
  isDefault   Boolean  @default(false)
}

model BankAccount {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankName      String   
  accountNumber String
  accountType   String   
  holderName    String
  isDefault     Boolean  @default(false)
}

model NotificationSettings {
  id              String  @id @default(cuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailOrders     Boolean @default(true)
  whatsappPromos  Boolean @default(false)
  securityAlerts  Boolean @default(true)
}

// ==========================================
// E-COMMERCE & OPERACIONES
// ==========================================
model Order {
  id             String      @id @default(cuid())
  orderNumber    String      @unique 
  userId         String
  user           User        @relation(fields: [userId], references: [id])
  status         String      @default("PENDING") 
  total          Float
  trackingNumber String?
  carrier        String?     
  items          OrderItem[]
  createdAt      DateTime    @default(now())
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id])
  productId   String
  productName String
  quantity    Int
  price       Float
  imei        String? 
}

model RepairTicket {
  id           String   @id @default(cuid())
  ticketNumber String   @unique 
  
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  
  deviceModel  String   
  issue        String   
  
  // CAMPO NUEVO PARA SERVICIOS (Pantalla/Batería)
  serviceType  String   @default("GENERAL") 
  
  status       String   @default("PENDING") 
  cost         Float?
  notes        String?  
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==========================================
// INVENTARIO & PRODUCTOS (OPTIMIZADO)
// ==========================================
model Producto {
  id             String   @id @default(cuid())
  imei           String?  @unique 
  
  // Información Visual
  nombre         String   
  marca          String
  modelo         String
  descripcion    String?  @db.Text
  
  // Precios y Estado
  precioVenta    Float    
  precioCompra   Float?   
  precioAnterior Float?   @default(0)
  enOferta       Boolean  @default(false)
  estado         String   @default("DISPONIBLE") 
  stock          Int      @default(1)

  // RELACIONES NUEVAS (Estilo Apple)
  imagenes       ImagenProducto[]
  colores        ColorProducto[]
  almacenamiento OpcionAlmacenamiento[]
  
  // Relaciones legacy/operativas
  specsId        String?                   @unique
  specs          EspecificacionesTecnicas? @relation(fields: [specsId], references: [id])
  
  userId         String?   
  user           User?    @relation(fields: [userId], references: [id])
  venta          Venta?
  wishlistItems  Wishlist[]

  // Campo legacy para compatibilidad
  fotosJson      String?  @db.Text 
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  fechaVenta     DateTime?
  fechaCompra    DateTime @default(now())
}

// Sub-tablas para Detalles del Producto
model ImagenProducto {
  id         String   @id @default(cuid())
  url        String
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
}

model ColorProducto {
  id         String   @id @default(cuid())
  nombre     String   
  hexCode    String   
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
}

model OpcionAlmacenamiento {
  id         String   @id @default(cuid())
  capacidad  String   
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
}

model EspecificacionesTecnicas {
  id           String    @id @default(cuid())
  
  // Textos descriptivos
  procesador   String?
  ram          String?
  bateria      String?
  camara       String?
  pantalla     String?
  sistema      String?

  // Scores Numéricos
  bateriaScore Int       @default(100) 
  camaraScore  Int       @default(80)
  gamingScore  Int       @default(80)
  resistencia  Int       @default(80)
  
  producto     Producto?
}

// ==========================================
// OTROS (Clientes, Ventas, Logs...)
// ==========================================
model Cliente {
  id        String   @id @default(cuid())
  nombre    String
  telefono  String?
  email     String?
  cedula    String?  
  direccion String?
  notas     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  compras   Venta[]
}

model Venta {
  id          String   @id @default(cuid())
  clienteId   String?  
  clienteRel  Cliente? @relation(fields: [clienteId], references: [id])
  cliente     String? 
  notas       String?
  precioVenta Float
  costo       Float?
  margen      Float?
  createdAt   DateTime @default(now())
  productoId  String   @unique
  producto    Producto @relation(fields: [productoId], references: [id])
  userId      String?   
  user        User?    @relation(fields: [userId], references: [id])
}

model Testimonio {
  id           String   @id @default(cuid())
  nombre       String   
  mensaje      String   @db.Text
  calificacion Int      @default(5) 
  fotoUrl      String?
  activo       Boolean  @default(false) 
  destacado    Boolean  @default(false) 
  createdAt    DateTime @default(now())
}

model AlertaStock {
  id        String   @id @default(cuid())
  email     String?
  telefono  String?
  busqueda  String   
  atendido  Boolean  @default(false) 
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  accion    String   
  entidad   String   
  entidadId String   
  detalles  String   
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model Wishlist {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id])
  createdAt  DateTime @default(now())
  @@unique([userId, productoId]) 
}

model QuoteRequest {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  customerName  String
  customerPhone String
  customerEmail String
  brand         String
  model         String
  storage       String
  condition     String   
  details       String?  @db.Text
  images        String[]
  status        String   @default("PENDING") 
  finalPrice    Float?   
}